<!DOCTYPE html>
<link rel="stylesheet" href="../js/katex/katex.min.css">
<script src="../js/katex/katex.min.js"></script>
<script src="../js/d3.v5.min.js"></script>
<script src="../js/pumbaa.js"></script>
<div id="dataviz-1"></div>

<div id="dataviz"></div>

<style>
  .axis {
    shape-rendering: crispEdges;
  }
  .tooltip {  
  position: absolute;     
  text-align: center;
  /* height: 28px;           */     
  font: 12px sans-serif;    
  border: 0px;  
  pointer-events: none;   
  font-size: 16px;  
  }
  #tooltip-left{
    color:#ffffff;
    padding: 2px; 
    float: left;
  }
  #tooltip-right{
    float: left;
    padding: 2px; 
    color:#625F5D;
    background: hsla(0, 0%, 100%, 0.525);
    /* opacity: 0.5; */
  }
  .x-axis text, .y-axis text{
    font-size: 20px;
    fill:#625F5D;
  }
  .x-axis line, .y-axis line{
    stroke: #625F5D;
  }
  .x-axis path, .y-axis path{
    stroke: #BFBFBA;
    stroke-width:2px;
  }
  .tick line{
     stroke: #BFBFBA;
  }
  .xTicks{
    color:#625F5D;
  }
  .zeroline{
    stroke: #BFBFBA;
    stroke-width:2px;
  }
  svg circle{
  cursor: crosshair
  }
</style>

<script>
  // setup for canvas
  var margin = {top: 80, right: 80, bottom: 80, left: 80}
  var settings = 200; 
  var width = 1100 - settings- margin.left - margin.right;
  var height = 700 - margin.top - margin.bottom;

  // Scales and axes. Note the inverted domain for the y-scale: bigger is up!
  var x = d3.scaleLinear().range([0, width]) //.domain([kmin,kmax]);
  var y = d3.scaleLinear().range([height, 0]) //.domain([-8, 4]);

  d3.csv("band_test.csv", type).then(data => {
    draw(data)
  });

  // d3.dsv(',', "bands.1", type).then(data => {
  //   console.log(data)
  //   draw(data)
  // });

  function draw(data){

    var kmin = d3.min(data, d => d.k)
    var kmax = d3.max(data, d => d.k)
    var emax = 5
    var emin = -9

    x.domain([kmin,kmax])
    y.domain([emin,emax])

    // A line generator, for the dark stroke.
    var line = d3.line().defined(function(d,i) { 
      var next = 0
      if (i<data.length-1){
        next = data[i+1].k
        return d.k <= next && d.e >=emin && d.e <=emax ;
        } 
      })
      .x(d => x(d.k))
      .y(d => y(d.e));

      var hSym =[
        {'x':0.00000,'T': '$\\Gamma$'.toTex()},
        {'x':0.45562,'T': '$R$'.toTex()},
        {'x':0.82763,'T': '$X$'.toTex()},
        {'x':1.09068,'T': '$M$'.toTex()},
        {'x':1.46269,'T': '$\\Gamma$'.toTex()},
        {'x':1.72574,'T': '$X$'.toTex()}
      ]

      // Add an SVG element with the desired dimensions and margin.
      var svg = d3.select("#dataviz").append("svg")
          .attr("width", width + margin.left + margin.right + settings)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

      // Add the x-axis.
      svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0," + (height) + ")")
          .call(d3.axisBottom(x).tickValues(hSym.map( (d) => d.x )).tickFormat((d)=>'').tickSize(-height))

      svg.append("g")
          .attr("class", "x-axis")
          .attr("transform", "translate(0,0)")
          .call(d3.axisTop(x).tickValues(hSym.map( (d) => d.x )).tickFormat((d)=>'').tickSize(-5))

      // Add the y-axis.
      svg.append("g")
          .attr("class", "y-axis")
          .attr("transform", "translate(" + 0 + ",0)")
          .call(d3.axisLeft(y).ticks(7).tickSize(-5));//.

      var tx = -7;
      var ty = 10;
      var tw = 50;
      var th = 50;

      svg.append("g")
        .call(x)
        .selectAll("g").data(hSym).enter().append("foreignObject")
        .attr('class','xTicks')
        .attr("transform", "translate(0," + (height) + ")")
        .attr("width", tw)
        .attr("height", th)
        .attr("x", (d)=>x(d.x)+tx)
        .attr("y", ty)
        .html(function(d){ return d.T})

       svg.append('line')
        .attr('class', 'zeroline')
        .attr('x1', x(kmin))
        .attr('y1', y(0))
        .attr('x2', x(kmax))
        .attr('y2', y(0))
        .style("stroke-dasharray", ("3, 3"))

      svg.selectAll('band')
        .data([data]).enter().append("path")
        .attr("class", "line")
        .attr('stroke', '#78AC5A')
        .attr("stroke-width", 3)
        .attr("fill",'none')
        .attr("d", line);

      svg.selectAll('dot').data(data.filter(function(d) { return d.e >=emin && d.e <=emax ; }))
        .enter().append('circle')
        .attr('class','dots')
        .on("mouseover", mouseover)
        .on("mousemove", mousemove)
        .on("mouseleave", mouseleave)
        .attr('r',1)
        .attr('cx', d => x(d.k))
        .attr('cy', d => y(d.e))
        .attr('fill','#78AC5A')
  }

  // helper functions
  function type(d) {
    d.k = +d.k;
    d.e = +d.e;
    return d;
  }
  var f = d3.format(".2f")
  // create a tooltip
var Tooltip = d3.select("#dataviz")
  .append("div")
  .style("opacity", 0)
  .attr("class", "tooltip")

// Three function that change the tooltip when user hover / move / leave a cell
var mouseover = function(d) {
  Tooltip.style("opacity", 1)
  d3.select(this)
  .attr('r',6)
}

var mousemove = function(d) {
  bgColor=d3.select(this).attr("fill")
  symbol = 'MAPI'
  Tooltip.attr("alignment-baseline", "middle")
  .html(
    `<div id='tooltip-left' style="background:${bgColor}">`
    + f(d.e)
    +`</div><div id='tooltip-right' style="color:${bgColor}">`
    +symbol+`</div>`
    )
  .style("left", (d3.mouse(this)[0]+40) + "px")
  .style("top", (d3.mouse(this)[1]+60) + "px")
}

var mouseleave = function(d) {
    Tooltip.style("opacity", 0)
    d3.select(this).attr('r',1)
}
</script>